<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
<title>AR Design Studio â€“ Full Build</title>

<style>
html,body{margin:0;height:100%;overflow:hidden;background:#000;font-family:system-ui}
canvas{position:fixed;inset:0;z-index:1}

#ui{
 position:fixed;inset:0;z-index:1000;
 pointer-events:auto;color:#fff
}

.glass{
 background:rgba(20,20,20,.65);
 backdrop-filter:blur(14px);
 border:1px solid rgba(255,255,255,.1);
}

#hint{
 position:absolute;top:14px;left:50%;
 transform:translateX(-50%);
 padding:8px 16px;border-radius:16px;
 font-size:13px;pointer-events:none
}

#toolbar{
 position:absolute;bottom:20px;width:100%;
 display:flex;justify-content:center;gap:8px
}

.tool{
 padding:12px 14px;border-radius:14px;
 cursor:pointer;user-select:none
}
.tool.active{background:#00e5ff;color:#000}

#ar-start-btn{
 position:fixed!important;
 left:50%!important;
 bottom:110px!important;
 transform:translateX(-50%);
 z-index:2000!important;
}
</style>

<script type="importmap">
{
 "imports":{
  "three":"https://unpkg.com/three@0.160.0/build/three.module.js",
  "three/addons/":"https://unpkg.com/three@0.160.0/examples/jsm/"
 }
}
</script>
</head>

<body>

<div id="ui">
 <div id="hint" class="glass">Move phone to detect surface</div>

 <div id="toolbar">
  <div class="tool glass active" data-t="add">â•</div>
  <div class="tool glass" data-t="draw">âœï¸</div>
  <div class="tool glass" data-t="measure">ğŸ“</div>
  <div class="tool glass" data-t="undo">â†©ï¸</div>
  <div class="tool glass" data-t="redo">â†ªï¸</div>
  <div class="tool glass" data-t="save">ğŸ’¾</div>
  <div class="tool glass" data-t="clear">ğŸ—‘</div>
 </div>
</div>

<script type="module">
import * as THREE from 'three';
import { ARButton } from 'three/addons/webxr/ARButton.js';

/* ---------------- STATE ---------------- */
let tool='add';
let history=[],future=[];
let drawing=false;
let drawPts=[],drawLine=null;
let measurePts=[];
let selected=null;

/* ---------------- SCENE ---------------- */
const scene=new THREE.Scene();
const camera=new THREE.PerspectiveCamera(70,innerWidth/innerHeight,.01,20);

const renderer=new THREE.WebGLRenderer({alpha:true,antialias:true});
renderer.setSize(innerWidth,innerHeight);
renderer.xr.enabled=true;
renderer.domElement.style.pointerEvents='none';
document.body.appendChild(renderer.domElement);

scene.add(new THREE.HemisphereLight(0xffffff,0xbbbbff,1.5));

/* ---------------- RETICLE ---------------- */
const reticle=new THREE.Mesh(
 new THREE.RingGeometry(.15,.2,32).rotateX(-Math.PI/2),
 new THREE.MeshBasicMaterial({color:0x00ff88})
);
reticle.visible=false;
scene.add(reticle);

/* ---------------- XR BUTTON ---------------- */
const arBtn=ARButton.createButton(renderer,{
 requiredFeatures:['hit-test','dom-overlay'],
 domOverlay:{root:document.getElementById('ui')}
});
arBtn.id='ar-start-btn';
document.body.appendChild(arBtn);

renderer.xr.addEventListener('sessionstart',()=>arBtn.style.display='none');
renderer.xr.addEventListener('sessionend',()=>arBtn.style.display='block');

/* ---------------- HIT TEST ---------------- */
let hitSource=null,requested=false;
renderer.xr.addEventListener('sessionend',()=>{hitSource=null;requested=false});

/* ---------------- HELPERS ---------------- */
function snapshot(){history.push(scene.toJSON());future.length=0}
function restore(json){
 while(scene.children.length>0) scene.remove(scene.children[0]);
 new THREE.ObjectLoader().parse(json,scene);
}

/* ---------------- OBJECT ---------------- */
function addObject(){
 snapshot();
 const mesh=new THREE.Mesh(
  new THREE.BoxGeometry(.25,.25,.25),
  new THREE.MeshStandardMaterial({color:0x00e5ff})
 );
 mesh.position.copy(reticle.position);
 mesh.position.y+=.125;
 scene.add(mesh);
}

/* ---------------- DRAW ---------------- */
function startDraw(){
 drawPts=[];
 drawLine=new THREE.Line(
  new THREE.BufferGeometry(),
  new THREE.LineBasicMaterial({color:0xff4444})
 );
 scene.add(drawLine);
}
function updateDraw(){
 drawPts.push(reticle.position.clone());
 drawLine.geometry.setFromPoints(drawPts);
}
function endDraw(){drawLine=null}

/* ---------------- MEASURE ---------------- */
function measure(){
 measurePts.push(reticle.position.clone());
 if(measurePts.length===2){
  const [a,b]=measurePts;
  alert(`Distance: ${a.distanceTo(b).toFixed(2)} m`);
  measurePts=[];
 }
}

/* ---------------- INPUT ---------------- */
window.addEventListener('pointerdown',()=>{
 if(!reticle.visible)return;
 if(tool==='add')addObject();
 if(tool==='draw'){drawing=true;startDraw()}
 if(tool==='measure')measure();
});

window.addEventListener('pointerup',()=>{
 if(drawing){drawing=false;endDraw()}
});

/* ---------------- UI ---------------- */
document.querySelectorAll('.tool').forEach(b=>{
 b.onclick=()=>{
  const t=b.dataset.t;
  document.querySelectorAll('.tool').forEach(x=>x.classList.remove('active'));
  b.classList.add('active');

  if(t==='undo'&&history.length){
   future.push(scene.toJSON());
   restore(history.pop());
  }else if(t==='redo'&&future.length){
   history.push(scene.toJSON());
   restore(future.pop());
  }else if(t==='clear'){
   snapshot();
   while(scene.children.length>0)scene.remove(scene.children[0]);
   scene.add(reticle);
  }else if(t==='save'){
   navigator.clipboard.writeText(JSON.stringify(scene.toJSON()));
   alert('Design copied');
  }else tool=t;
 };
});

/* ---------------- RENDER ---------------- */
renderer.setAnimationLoop((t,frame)=>{
 if(frame){
  const s=renderer.xr.getSession();
  if(!requested){
   s.requestReferenceSpace('viewer').then(sp=>{
    s.requestHitTestSource({space:sp}).then(src=>hitSource=src);
   });
   requested=true;
  }
  if(hitSource){
   const hits=frame.getHitTestResults(hitSource);
   if(hits.length){
    const p=hits[0].getPose(renderer.xr.getReferenceSpace());
    reticle.visible=true;
    reticle.position.set(p.transform.position.x,p.transform.position.y,p.transform.position.z);
    document.getElementById('hint').innerText='Tap to interact';
   }else{
    reticle.visible=false;
    document.getElementById('hint').innerText='Move to detect surface';
   }
  }
 }
 if(drawing&&drawLine)updateDraw();
 renderer.render(scene,camera);
});

addEventListener('resize',()=>{
 camera.aspect=innerWidth/innerHeight;
 camera.updateProjectionMatrix();
 renderer.setSize(innerWidth,innerHeight);
});
</script>
</body>
</html>
