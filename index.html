<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>AR Scanner V5 (Diagnostic)</title>
    <style>
        body { margin: 0; overflow: hidden; background: #111; font-family: sans-serif; color: white; }
        
        /* ERROR MODAL */
        #error-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(50,0,0,0.9); z-index: 999; display: none;
            flex-direction: column; align-items: center; justify-content: center; text-align: center;
            padding: 20px; box-sizing: border-box;
        }
        .error-title { font-size: 24px; color: #ff4444; margin-bottom: 10px; font-weight: bold; }
        .error-msg { font-size: 16px; color: #ddd; margin-bottom: 20px; line-height: 1.5; }
        .btn { padding: 12px 24px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; margin-top: 10px; }
        .btn-force { background: #444; color: white; border: 1px solid #777; }
        
        /* UI LAYER */
        #ui-layer { position: absolute; inset: 0; pointer-events: none; }
        
        /* LOG CONSOLE */
        #console-log {
            position: absolute; top: 10px; left: 10px; width: 90%; height: 150px;
            background: rgba(0,0,0,0.5); pointer-events: none; overflow-y: auto;
            font-family: monospace; font-size: 11px; padding: 5px; border-left: 2px solid #0f0;
        }
        .log-line { margin-bottom: 2px; }
        .log-err { color: #ff5555; }
        .log-info { color: #55ff55; }

        /* CONTROLS */
        #controls {
            position: absolute; bottom: 20px; width: 100%; text-align: center; pointer-events: auto;
            display: flex; flex-direction: column; align-items: center; gap: 10px;
        }
        #scan-btn {
            background: #00E5FF; color: black; padding: 15px 30px; border-radius: 30px;
            font-size: 16px; font-weight: bold; border: none; display: none;
        }
    </style>

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>
</head>
<body>

    <div id="error-overlay">
        <div class="error-title">Startup Failed</div>
        <div class="error-msg" id="error-text">Unknown Error</div>
        <button class="btn btn-force" onclick="app.forceStart()">Try Force Start</button>
    </div>

    <div id="ui-layer">
        <div id="console-log"></div>
        <div id="controls">
            <button id="scan-btn" onclick="app.scanner.trigger()">PLACE SCANNER</button>
            <div id="ar-prompt"></div>
        </div>
    </div>

    <script type="module">
        import * as THREE from 'three';
        import { ARButton } from 'three/addons/webxr/ARButton.js';

        // --- LOGGER UTILITY ---
        const logger = {
            log: (msg) => {
                console.log(msg);
                const el = document.getElementById('console-log');
                el.innerHTML += `<div class="log-line log-info">> ${msg}</div>`;
                el.scrollTop = el.scrollHeight;
            },
            error: (msg) => {
                console.error(msg);
                const el = document.getElementById('console-log');
                el.innerHTML += `<div class="log-line log-err">ERROR: ${msg}</div>`;
                el.scrollTop = el.scrollHeight;
                showError(msg);
            }
        };

        function showError(msg) {
            document.getElementById('error-overlay').style.display = 'flex';
            document.getElementById('error-text').innerHTML = msg;
        }

        class App {
            constructor() {
                this.sceneMgr = null;
                this.scanner = null;
                
                // 1. Run Pre-Flight Checks
                this.preFlightCheck();
            }

            async preFlightCheck() {
                logger.log("Starting Pre-Flight Checks...");

                // CHECK 1: HTTPS
                if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
                    logger.error("NOT HTTPS! WebXR requires a secure context (https://).");
                    return;
                }

                // CHECK 2: WebXR Support
                if ('xr' in navigator) {
                    try {
                        const supported = await navigator.xr.isSessionSupported('immersive-ar');
                        if (supported) {
                            logger.log("âœ… WebXR AR Supported");
                            this.init();
                        } else {
                            logger.error("WebXR exists but 'immersive-ar' is NOT supported on this device.");
                        }
                    } catch (e) {
                        logger.error("WebXR Check Failed: " + e.message);
                    }
                } else {
                    logger.error("WebXR API not found. (Are you on iOS Safari? Use 'WebXR Viewer' app or Enable Flags).");
                }
            }

            init() {
                try {
                    logger.log("Initializing Engine...");
                    this.sceneMgr = new SceneManager(this);
                    this.scanner = new Scanner(this);
                } catch(e) {
                    logger.error("Crash during Init: " + e.message);
                }
            }

            forceStart() {
                document.getElementById('error-overlay').style.display = 'none';
                this.init();
            }
        }

        class SceneManager {
            constructor(app) {
                this.app = app;
                
                this.scene = new THREE.Scene();
                this.camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.01, 20);
                
                const light = new THREE.HemisphereLight(0xffffff, 0xbbbbff, 3);
                this.scene.add(light);

                this.renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
                this.renderer.setSize(window.innerWidth, window.innerHeight);
                this.renderer.xr.enabled = true;
                document.body.appendChild(this.renderer.domElement);

                // AR Button
                const btn = ARButton.createButton(this.renderer, { 
                    requiredFeatures: ['hit-test', 'dom-overlay'], 
                    domOverlay: { root: document.getElementById('ui-layer') } 
                });
                document.getElementById('ar-prompt').appendChild(btn);

                // Reticle
                this.reticle = new THREE.Mesh(
                    new THREE.RingGeometry(0.15, 0.2, 32).rotateX(-Math.PI / 2),
                    new THREE.MeshBasicMaterial({ color: 0x00ff00 })
                );
                this.reticle.visible = false;
                this.scene.add(this.reticle);

                // Click Listener for AR Start
                btn.addEventListener('click', () => {
                    logger.log("AR Session Starting...");
                    document.getElementById('scan-btn').style.display = 'block';
                });

                this.renderer.setAnimationLoop((t, f) => this.render(t, f));
            }

            render(t, frame) {
                if(frame) {
                    const session = this.renderer.xr.getSession();
                    // HIT TEST LOGIC
                    if(!this.hitSourceRequested) {
                        session.requestReferenceSpace('viewer').then(ref => {
                            session.requestHitTestSource({ space: ref }).then(src => this.hitSource = src);
                        });
                        this.hitSourceRequested = true;
                    }

                    if(this.hitSource) {
                        const hits = frame.getHitTestResults(this.hitSource);
                        if(hits.length > 0) {
                            const hit = hits[0];
                            const pose = hit.getPose(this.renderer.xr.getReferenceSpace());
                            this.reticle.visible = true;
                            this.reticle.matrix.fromArray(pose.transform.matrix);
                            this.reticle.matrixAutoUpdate = false; // Optimize
                        } else {
                            this.reticle.visible = false;
                        }
                    }
                }
                
                // Animation Hooks
                if(this.app.scanner) this.app.scanner.update(t);

                this.renderer.render(this.scene, this.camera);
            }
        }

        class Scanner {
            constructor(app) {
                this.app = app;
                this.rig = null;
                this.scanning = false;
            }

            trigger() {
                const reticle = this.app.sceneMgr.reticle;
                
                if(!this.rig) {
                    // PHASE 1: PLACE
                    if(reticle.visible) {
                        logger.log("Placing Scanner Rig...");
                        this.createRig(reticle.matrix);
                        document.getElementById('scan-btn').innerText = "START SCAN";
                    } else {
                        logger.log("Cannot Place: Point at floor first!");
                    }
                } else if(!this.scanning) {
                    // PHASE 2: SCAN
                    logger.log("Scanning...");
                    this.scanning = true;
                    this.scanAnimStart = performance.now();
                    document.getElementById('scan-btn').style.display = 'none'; // Hide btn
                }
            }

            createRig(matrix) {
                this.rig = new THREE.Group();
                this.rig.position.setFromMatrixPosition(matrix);
                this.rig.quaternion.setFromRotationMatrix(matrix);

                // Box
                const box = new THREE.Mesh(new THREE.BoxGeometry(0.4, 0.4, 0.4), new THREE.MeshBasicMaterial({ color: 0x00E5FF, wireframe: true }));
                box.position.y = 0.2;
                this.rig.add(box);

                // Laser
                this.laser = new THREE.Mesh(new THREE.PlaneGeometry(0.38, 0.38), new THREE.MeshBasicMaterial({ color: 0xff0000, side: 2, opacity: 0.5, transparent: true }));
                this.laser.rotation.x = Math.PI/2;
                this.laser.position.y = 0.05;
                this.rig.add(this.laser);

                this.app.sceneMgr.scene.add(this.rig);
            }

            update(t) {
                if(this.scanning && this.rig) {
                    const elapsed = t - this.scanAnimStart;
                    
                    // Move Laser
                    this.laser.position.y = 0.2 + Math.sin(elapsed * 0.005) * 0.18;

                    // Finish after 3 seconds
                    if(elapsed > 3000) {
                        this.scanning = false;
                        this.finish();
                    }
                }
            }

            finish() {
                logger.log("Scan Complete! Creating Twin.");
                this.app.sceneMgr.scene.remove(this.rig);
                
                // Create Twin
                const geo = new THREE.DodecahedronGeometry(0.2);
                const mat = new THREE.MeshStandardMaterial({ color: 0x00E5FF, metalness: 0.8, roughness: 0.1 });
                const mesh = new THREE.Mesh(geo, mat);
                mesh.position.copy(this.rig.position);
                mesh.position.y = 0.2;
                this.app.sceneMgr.scene.add(mesh);
                
                // Add Reset Button
                const btn = document.getElementById('scan-btn');
                btn.style.display = 'block';
                btn.innerText = "RESET";
                btn.onclick = () => location.reload();
            }
        }

        // START
        window.app = new App();
    </script>
</body>
</html>
