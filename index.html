<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
<title>AR Design Editor – Final Base</title>

<style>
html,body{margin:0;height:100%;overflow:hidden;background:#000;font-family:system-ui}
canvas{position:fixed;inset:0;z-index:1}

#ui{position:fixed;inset:0;z-index:10;color:#fff;pointer-events:auto}
.glass{background:rgba(20,20,20,.7);backdrop-filter:blur(12px);border:1px solid rgba(255,255,255,.1)}

#hint{position:absolute;top:12px;left:50%;transform:translateX(-50%);padding:8px 16px;border-radius:14px;font-size:13px}

#toolbar{position:absolute;bottom:16px;width:100%;display:flex;justify-content:center;gap:8px}
.tool{padding:10px 14px;border-radius:14px;cursor:pointer}
.tool.active{background:#00e5ff;color:#000}

.panel{position:absolute;top:60px;bottom:80px;width:220px;padding:10px;overflow:auto}
#inspector{left:10px}
#hierarchy{right:10px}

.item{padding:6px;border-radius:8px;cursor:pointer;font-size:13px}
.item.active{background:#00e5ff;color:#000}

input,select,button{width:100%;margin-bottom:6px;background:#111;color:#fff;border:1px solid #333;border-radius:6px;padding:6px}
button{cursor:pointer}

#ar-start-btn{position:fixed!important;left:50%!important;bottom:110px!important;transform:translateX(-50%);z-index:20!important}
</style>

<script type="importmap">
{
 "imports":{
  "three":"https://unpkg.com/three@0.160.0/build/three.module.js",
  "three/addons/":"https://unpkg.com/three@0.160.0/examples/jsm/"
 }
}
</script>
</head>

<body>

<div id="ui">
 <div id="hint" class="glass">Start AR → Add or Select objects</div>

 <div id="inspector" class="panel glass">
  <h4>Inspector</h4>
  <div id="props"></div>
 </div>

 <div id="hierarchy" class="panel glass">
  <h4>Hierarchy</h4>
  <div id="list"></div>
 </div>

 <div id="toolbar">
  <div class="tool glass active" data-add="cube">Cube</div>
  <div class="tool glass" data-add="sphere">Sphere</div>
  <div class="tool glass" data-add="cylinder">Cylinder</div>
  <div class="tool glass" data-add="plane">Plane</div>
  <div class="tool glass" data-add="text">Text</div>
 </div>
</div>

<script type="module">
import * as THREE from 'three';
import { ARButton } from 'three/addons/webxr/ARButton.js';

/* ===================== PUB SUB ===================== */
const Bus={e:{},on(k,f){(this.e[k]??=[]).push(f)},emit(k,d){(this.e[k]||[]).forEach(f=>f(d))}};

/* ===================== STATE ===================== */
const State={mode:'add',set(m){this.mode=m}};

/* ===================== MODEL ===================== */
const Model={
 objs:[],sel:null,
 add(o){this.objs.push(o);Bus.emit('update')},
 select(id){this.sel=id;Bus.emit('select')},
 getSel(){return this.objs.find(o=>o.id===this.sel)}
};

/* ===================== AR VIEW ===================== */
const scene=new THREE.Scene();
const camera=new THREE.PerspectiveCamera(70,innerWidth/innerHeight,.01,20);
const renderer=new THREE.WebGLRenderer({alpha:true,antialias:true});
renderer.setSize(innerWidth,innerHeight);
renderer.xr.enabled=true;
renderer.domElement.style.pointerEvents='none';
document.body.appendChild(renderer.domElement);

scene.add(new THREE.HemisphereLight(0xffffff,0xbbbbff,1.5));

const reticle=new THREE.Mesh(
 new THREE.RingGeometry(.12,.16,32).rotateX(-Math.PI/2),
 new THREE.MeshBasicMaterial({color:0x00ff88})
);
reticle.visible=false;
scene.add(reticle);

const arBtn=ARButton.createButton(renderer,{
 requiredFeatures:['hit-test','dom-overlay'],
 domOverlay:{root:document.getElementById('ui')}
});
arBtn.id='ar-start-btn';
document.body.appendChild(arBtn);
renderer.xr.addEventListener('sessionstart',()=>arBtn.style.display='none');

const meshes=new Map();

/* ===================== OBJECT FACTORY ===================== */
function makeMesh(o){
 let g;
 if(o.type==='cube')g=new THREE.BoxGeometry(.25,.25,.25);
 if(o.type==='sphere')g=new THREE.SphereGeometry(.15,32,32);
 if(o.type==='cylinder')g=new THREE.CylinderGeometry(.12,.12,.25,32);
 if(o.type==='plane')g=new THREE.PlaneGeometry(.3,.3);
 if(o.type==='text'){
  const c=document.createElement('canvas');c.width=512;c.height=256;
  const x=c.getContext('2d');x.fillStyle='#fff';x.font='48px sans-serif';x.fillText(o.text,40,140);
  const t=new THREE.CanvasTexture(c);
  g=new THREE.PlaneGeometry(.4,.2);
  return new THREE.Mesh(g,new THREE.MeshBasicMaterial({map:t,transparent:true}));
 }
 return new THREE.Mesh(g,new THREE.MeshStandardMaterial({color:o.color}));
}

/* ===================== SYNC ===================== */
Bus.on('update',()=>{
 Model.objs.forEach(o=>{
  if(!meshes.has(o.id)){
   const m=makeMesh(o);
   scene.add(m);
   meshes.set(o.id,m);
  }
  const m=meshes.get(o.id);
  m.position.set(o.p.x,o.p.y,o.p.z);
  m.scale.set(o.s,o.s,o.s);
  m.rotation.y=o.r;
 });
 renderUI();
});

/* ===================== UI ===================== */
function renderUI(){
 const list=document.getElementById('list');
 const props=document.getElementById('props');
 list.innerHTML='';props.innerHTML='';
 Model.objs.forEach(o=>{
  const d=document.createElement('div');
  d.className='item'+(o.id===Model.sel?' active':'');
  d.textContent=o.type;
  d.onclick=()=>Model.select(o.id);
  list.appendChild(d);
 });
 const o=Model.getSel();
 if(!o)return;
 props.innerHTML=`
 <label>Scale</label><input type="range" min="0.1" max="2" step="0.1" value="${o.s}" oninput="window.edit('s',this.value)">
 <label>Rotate</label><input type="range" min="0" max="6.28" step="0.1" value="${o.r}" oninput="window.edit('r',this.value)">
 ${o.type==='text'?`<label>Text</label><input value="${o.text}" oninput="window.edit('text',this.value)">`:''}
 `;
}
window.edit=(k,v)=>{const o=Model.getSel();o[k]=k==='text'?v:parseFloat(v);Bus.emit('update')};

/* ===================== INPUT ===================== */
window.addEventListener('pointerdown',()=>{
 if(!reticle.visible)return;
 const o={id:crypto.randomUUID(),type:State.mode,p:{x:reticle.position.x,y:reticle.position.y+.05,z:reticle.position.z},s:1,r:0,color:0x00e5ff,text:'Text'};
 Model.add(o);Model.select(o.id);
});

/* ===================== TOOLBAR ===================== */
document.querySelectorAll('.tool').forEach(b=>{
 b.onclick=()=>{document.querySelectorAll('.tool').forEach(x=>x.classList.remove('active'));b.classList.add('active');State.mode=b.dataset.add};
});

/* ===================== HIT TEST LOOP ===================== */
let hit=null,req=false;
renderer.setAnimationLoop((t,f)=>{
 if(f){
  const s=renderer.xr.getSession();
  if(!req){s.requestReferenceSpace('viewer').then(sp=>s.requestHitTestSource({space:sp}).then(h=>hit=h));req=true}
  if(hit){
   const r=f.getHitTestResults(hit);
   if(r.length){
    const p=r[0].getPose(renderer.xr.getReferenceSpace());
    reticle.visible=true;
    reticle.position.set(p.transform.position.x,p.transform.position.y,p.transform.position.z);
   }
  }
 }
 renderer.render(scene,camera);
});
</script>
</body>
</html>
