<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
<title>AR Design Studio ‚Äì Fixed Start Button</title>

<style>
html, body {
    margin: 0;
    padding: 0;
    width: 100%;
    height: 100%;
    overflow: hidden;
    background: #000;
    font-family: system-ui, -apple-system, Segoe UI, Roboto;
}

/* CAMERA CANVAS */
canvas {
    position: fixed;
    inset: 0;
    z-index: 1;
}

/* UI ROOT */
#ui-root {
    position: fixed;
    inset: 0;
    z-index: 1000;
    pointer-events: auto;
}

/* GLASS UI */
.glass {
    background: rgba(20,20,20,0.65);
    backdrop-filter: blur(14px);
    border: 1px solid rgba(255,255,255,0.1);
    color: #fff;
}

/* TOP HINT */
#hint {
    position: absolute;
    top: 16px;
    left: 50%;
    transform: translateX(-50%);
    padding: 10px 18px;
    border-radius: 20px;
    font-size: 13px;
    pointer-events: none;
}

/* TOOLBAR */
#toolbar {
    position: absolute;
    bottom: 20px;
    width: 100%;
    display: flex;
    justify-content: center;
    gap: 10px;
}

.tool {
    padding: 12px 16px;
    border-radius: 16px;
    cursor: pointer;
    user-select: none;
}

.tool.active {
    background: #00e5ff;
    color: #000;
}

/* START AR BUTTON FIX */
#ar-start-btn {
    position: fixed !important;
    left: 50% !important;
    bottom: 110px !important; /* above toolbar */
    transform: translateX(-50%);
    z-index: 2000 !important;
    pointer-events: auto !important;
}
</style>

<script type="importmap">
{
  "imports": {
    "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
    "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
  }
}
</script>
</head>

<body>

<!-- UI OVERLAY -->
<div id="ui-root">
    <div id="hint" class="glass">Move phone to detect surface</div>

    <div id="toolbar">
        <div class="tool glass active" data-tool="add">‚ûï Add</div>
        <div class="tool glass" data-tool="draw">‚úèÔ∏è Draw</div>
        <div class="tool glass" data-tool="measure">üìê Measure</div>
        <div class="tool glass" data-tool="clear">üóë Clear</div>
    </div>
</div>

<script type="module">
import * as THREE from 'three';
import { ARButton } from 'three/addons/webxr/ARButton.js';

/* ---------------- STATE ---------------- */
const state = {
    tool: 'add',
    drawing: false,
    drawPoints: [],
    measurePoints: []
};

/* ---------------- SCENE ---------------- */
const scene = new THREE.Scene();
const camera = new THREE.PerspectiveCamera(70, innerWidth / innerHeight, 0.01, 20);

const renderer = new THREE.WebGLRenderer({ alpha: true, antialias: true });
renderer.setSize(innerWidth, innerHeight);
renderer.setPixelRatio(Math.min(devicePixelRatio, 2));
renderer.xr.enabled = true;
document.body.appendChild(renderer.domElement);

/* CRITICAL: allow UI to receive touches */
renderer.domElement.style.pointerEvents = 'none';

scene.add(new THREE.HemisphereLight(0xffffff, 0xbbbbff, 1.5));

/* ---------------- RETICLE ---------------- */
const reticle = new THREE.Mesh(
    new THREE.RingGeometry(0.15, 0.2, 32).rotateX(-Math.PI / 2),
    new THREE.MeshBasicMaterial({ color: 0x00ff88 })
);
reticle.visible = false;
scene.add(reticle);

/* ---------------- AR BUTTON ---------------- */
const arBtn = ARButton.createButton(renderer, {
    requiredFeatures: ['hit-test', 'dom-overlay'],
    domOverlay: { root: document.getElementById('ui-root') }
});
arBtn.id = 'ar-start-btn';
document.body.appendChild(arBtn);

/* Hide button once AR starts */
renderer.xr.addEventListener('sessionstart', () => {
    arBtn.style.display = 'none';
});

/* ---------------- HIT TEST ---------------- */
let hitSource = null;
let hitRequested = false;

renderer.xr.addEventListener('sessionend', () => {
    hitSource = null;
    hitRequested = false;
    arBtn.style.display = 'block';
});

/* ---------------- TOOLS ---------------- */
function addBox() {
    const box = new THREE.Mesh(
        new THREE.BoxGeometry(0.25, 0.25, 0.25),
        new THREE.MeshStandardMaterial({ color: 0x00e5ff })
    );
    box.position.copy(reticle.position);
    box.position.y += 0.125;
    scene.add(box);
}

let drawLine = null;
function startDraw() {
    state.drawPoints = [];
    drawLine = new THREE.Line(
        new THREE.BufferGeometry(),
        new THREE.LineBasicMaterial({ color: 0xff4444 })
    );
    scene.add(drawLine);
}
function updateDraw() {
    state.drawPoints.push(reticle.position.clone());
    drawLine.geometry.setFromPoints(state.drawPoints);
}
function endDraw() {
    drawLine = null;
}

function measure() {
    state.measurePoints.push(reticle.position.clone());
    if (state.measurePoints.length === 2) {
        const [a, b] = state.measurePoints;
        alert(`Distance: ${a.distanceTo(b).toFixed(2)} meters`);
        state.measurePoints = [];
    }
}

/* ---------------- INPUT ---------------- */
window.addEventListener('pointerdown', () => {
    if (!reticle.visible) return;

    if (state.tool === 'add') addBox();
    if (state.tool === 'draw') { state.drawing = true; startDraw(); }
    if (state.tool === 'measure') measure();
});

window.addEventListener('pointerup', () => {
    if (state.drawing) {
        state.drawing = false;
        endDraw();
    }
});

/* ---------------- UI EVENTS ---------------- */
document.querySelectorAll('.tool').forEach(btn => {
    btn.onclick = () => {
        document.querySelectorAll('.tool').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        state.tool = btn.dataset.tool;

        if (state.tool === 'clear') {
            scene.children
                .filter(o => o.isMesh || o.isLine)
                .forEach(o => scene.remove(o));
            scene.add(reticle);
        }
    };
});

/* ---------------- RENDER LOOP ---------------- */
renderer.setAnimationLoop((t, frame) => {
    if (frame) {
        const session = renderer.xr.getSession();

        if (!hitRequested) {
            session.requestReferenceSpace('viewer').then(space => {
                session.requestHitTestSource({ space }).then(src => hitSource = src);
            });
            hitRequested = true;
        }

        if (hitSource) {
            const hits = frame.getHitTestResults(hitSource);
            if (hits.length) {
                const pose = hits[0].getPose(renderer.xr.getReferenceSpace());
                reticle.visible = true;
                reticle.position.set(
                    pose.transform.position.x,
                    pose.transform.position.y,
                    pose.transform.position.z
                );
                document.getElementById('hint').innerText = 'Tap to interact';
            } else {
                reticle.visible = false;
                document.getElementById('hint').innerText = 'Move phone to detect surface';
            }
        }
    }

    if (state.drawing && drawLine) updateDraw();
    renderer.render(scene, camera);
});

/* ---------------- RESIZE ---------------- */
addEventListener('resize', () => {
    camera.aspect = innerWidth / innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(innerWidth, innerHeight);
});
</script>

</body>
</html>
