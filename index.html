<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no"/>
<title>AR Design Studio ‚Äì Production</title>

<style>
*{box-sizing:border-box}
body{
    margin:0;overflow:hidden;background:#000;color:#fff;
    font-family:system-ui,-apple-system,Segoe UI,Roboto;
}

/* GLASS UI */
.glass{
    background:rgba(20,20,20,.65);
    backdrop-filter:blur(14px);
    border:1px solid rgba(255,255,255,.08);
}

/* UI LAYER */
#ui{position:absolute;inset:0;pointer-events:none}

/* HINT */
#hint{
    position:absolute;top:16px;left:50%;
    transform:translateX(-50%);
    padding:10px 18px;
    border-radius:20px;
    font-size:13px;
}

/* TOOLBAR */
#toolbar{
    position:absolute;bottom:18px;width:100%;
    display:flex;justify-content:center;gap:8px;
    pointer-events:auto;
}
.tool{
    padding:12px 14px;border-radius:16px;
    font-size:14px;cursor:pointer;
}
.tool.active{background:#00e5ff;color:#000}

/* PANEL */
#panel{
    position:absolute;bottom:80px;left:50%;
    transform:translateX(-50%);
    padding:12px;border-radius:18px;
    display:none;gap:8px;
    pointer-events:auto;
}
.btn{
    padding:10px 14px;border-radius:14px;
    background:#222;font-size:13px;cursor:pointer;
}
.btn.primary{background:#00e5ff;color:#000}
</style>

<script type="importmap">
{
 "imports":{
  "three":"https://unpkg.com/three@0.160.0/build/three.module.js",
  "three/addons/":"https://unpkg.com/three@0.160.0/examples/jsm/"
 }
}
</script>
</head>

<body>

<div id="ui">
  <div id="hint" class="glass">Move device to detect surface</div>

  <div id="panel" class="glass"></div>

  <div id="toolbar">
    <div class="tool glass active" data-tool="add">‚ûï</div>
    <div class="tool glass" data-tool="draw">‚úèÔ∏è</div>
    <div class="tool glass" data-tool="measure">üìê</div>
    <div class="tool glass" data-tool="save">üíæ</div>
    <div class="tool glass" data-tool="clear">üóë</div>
  </div>
</div>

<script type="module">
import * as THREE from 'three';
import { ARButton } from 'three/addons/webxr/ARButton.js';

/* ---------------- STATE ---------------- */
const state={
 tool:'add',
 objects:[],
 drawings:[],
 measures:[],
 selected:null,
 drawing:false,
 drawPts:[],
 measurePts:[]
};

/* ---------------- SCENE ---------------- */
const scene=new THREE.Scene();
const camera=new THREE.PerspectiveCamera(70,innerWidth/innerHeight,.01,30);

const renderer=new THREE.WebGLRenderer({alpha:true,antialias:true});
renderer.setSize(innerWidth,innerHeight);
renderer.setPixelRatio(Math.min(devicePixelRatio,2));
renderer.xr.enabled=true;
document.body.appendChild(renderer.domElement);

scene.add(new THREE.HemisphereLight(0xffffff,0xbbbbff,1.6));

/* ---------------- RETICLE ---------------- */
const reticle=new THREE.Mesh(
 new THREE.RingGeometry(.15,.2,32).rotateX(-Math.PI/2),
 new THREE.MeshBasicMaterial({color:0x00ff88})
);
reticle.visible=false;
scene.add(reticle);

/* ---------------- XR BUTTON ---------------- */
document.body.appendChild(
 ARButton.createButton(renderer,{
  requiredFeatures:['hit-test','dom-overlay'],
  domOverlay:{root:document.getElementById('ui')}
 })
);

/* ---------------- HIT TEST ---------------- */
let hitSource=null,hitReq=false;
renderer.xr.addEventListener('sessionend',()=>{
 hitSource=null;hitReq=false;
});

/* ---------------- MATERIALS ---------------- */
const matBase=()=>new THREE.MeshStandardMaterial({
 color:0x00e5ff,metalness:.6,roughness:.25
});

/* ---------------- OBJECT CREATION ---------------- */
function addObject(){
 const mesh=new THREE.Mesh(
  new THREE.BoxGeometry(.25,.25,.25),
  matBase()
 );
 mesh.position.copy(reticle.position);
 mesh.position.y+=.125;
 scene.add(mesh);
 state.objects.push(mesh);
}

/* ---------------- DRAW ---------------- */
let drawLine=null;
const drawMat=new THREE.LineBasicMaterial({color:0xff4444});

function startDraw(){
 state.drawPts=[];
 drawLine=new THREE.Line(new THREE.BufferGeometry(),drawMat);
 scene.add(drawLine);
}
function updateDraw(){
 state.drawPts.push(reticle.position.clone());
 drawLine.geometry.setFromPoints(state.drawPts);
}
function endDraw(){
 state.drawings.push(drawLine);
 drawLine=null;
}

/* ---------------- MEASURE ---------------- */
function addMeasurePoint(){
 state.measurePts.push(reticle.position.clone());
 if(state.measurePts.length===2){
  const [a,b]=state.measurePts;
  const geo=new THREE.BufferGeometry().setFromPoints([a,b]);
  const line=new THREE.Line(geo,new THREE.LineBasicMaterial({color:0xffff00}));
  scene.add(line);

  const dist=a.distanceTo(b).toFixed(2);
  alert(`Distance: ${dist} meters`);

  state.measures.push(line);
  state.measurePts=[];
 }
}

/* ---------------- INPUT ---------------- */
renderer.domElement.addEventListener('pointerdown',()=>{
 if(!reticle.visible) return;

 if(state.tool==='add') addObject();
 if(state.tool==='draw'){state.drawing=true;startDraw();}
 if(state.tool==='measure') addMeasurePoint();
});

renderer.domElement.addEventListener('pointerup',()=>{
 if(state.drawing){state.drawing=false;endDraw();}
});

/* ---------------- UI ---------------- */
document.querySelectorAll('.tool').forEach(btn=>{
 btn.onclick=()=>{
  document.querySelectorAll('.tool').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  state.tool=btn.dataset.tool;

  if(state.tool==='clear'){
   [...state.objects,...state.drawings,...state.measures]
    .forEach(o=>scene.remove(o));
   state.objects=[];state.drawings=[];state.measures=[];
  }

  if(state.tool==='save'){
   const data={
    objects:state.objects.map(o=>({
     pos:o.position.toArray(),
     rot:o.rotation.toArray()
    }))
   };
   navigator.clipboard.writeText(JSON.stringify(data,null,2));
   alert("Design copied to clipboard");
  }
 };
});

/* ---------------- RENDER ---------------- */
renderer.setAnimationLoop((t,frame)=>{
 if(frame){
  const session=renderer.xr.getSession();
  if(!hitReq){
   session.requestReferenceSpace('viewer').then(s=>{
    session.requestHitTestSource({space:s}).then(src=>hitSource=src);
   });
   hitReq=true;
  }
  if(hitSource){
   const hits=frame.getHitTestResults(hitSource);
   if(hits.length){
    const p=hits[0].getPose(renderer.xr.getReferenceSpace());
    reticle.visible=true;
    reticle.position.set(
     p.transform.position.x,
     p.transform.position.y,
     p.transform.position.z
    );
    document.getElementById('hint').innerText="Tap to interact";
   }else{
    reticle.visible=false;
    document.getElementById('hint').innerText="Move to find surface";
   }
  }
 }
 if(state.drawing && drawLine) updateDraw();
 renderer.render(scene,camera);
});

/* ---------------- RESIZE ---------------- */
addEventListener('resize',()=>{
 camera.aspect=innerWidth/innerHeight;
 camera.updateProjectionMatrix();
 renderer.setSize(innerWidth,innerHeight);
});
</script>
</body>
</html>
